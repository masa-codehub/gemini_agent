name: Gemini Issue Handler

on:
  issues:
    types: [opened, labeled]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  gemini-implementation:
    # このジョブは、ユーザーが用意したサーバー(Self-Hosted Runner)上で実行されます
    # 複数ランナーが稼働している場合、空いているランナーが順次処理します
    runs-on: [self-hosted]
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_MCP_PAT || secrets.GITHUB_TOKEN }}
      AGENT_ROLE: SYSTEM_ARCHITECT

    steps:
      # 1. コードの取得: 最新のソースコードをRunner上にダウンロードします
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. 環境の初期化: 依存ライブラリのインストールやCLIのセットアップを行います
      #    run.sh 内で pip install や gemini extensions install が実行されます
      - name: Initialize Environment
        run: bash run.sh

      # 3. Geminiによる実装実行 (Implementer Loop):
      #    最大3回のループを行い、実装と自己修正を繰り返します。
      - name: Gemini Implementer Phase
        id: implementer
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          set -e
          echo "Processing Issue #${ISSUE_NUMBER}: $ISSUE_TITLE"

          # Issueの内容を一時ファイルに保存 (パイプ入力用)
          echo -e "# Issue Info\n\nTitle: $ISSUE_TITLE\n\n$ISSUE_BODY" > current_issue.md

          # 0回目: ブランチ戦略の決定と切り替え
          echo "--- Phase 0: Branch Strategy & Checkout ---"
          BRANCH_COMMAND=$( {
            cat .github/workflows/context/branch-strategy.md
            echo -e "\n---\n# Current Context\n"
            cat current_issue.md
          } | gemini -m "gemini-3-flash-preview")
          echo "Executing: $BRANCH_COMMAND"
          eval "$BRANCH_COMMAND"

          # 1回目: 初期実装
          echo "--- Phase 1: Initial Implementation ---"
          {
            cat .github/workflows/context/architecture-drafting.md
            echo -e "\n---\n# Current Context\n"
            cat current_issue.md
          } | gemini --yolo -m "gemini-3-flash-preview" > response.md

          # 2回目: 自己修正・改善 (テストのためコメントアウト)
          # echo "--- Phase 2: Refinement 1 ---"
          # {
          #   cat .github/workflows/context/architecture-drafting.md
          #   echo -e "\n---\n# Current Context\n"
          #   cat current_issue.md
          #   echo -e "\n---\n# Previous Response\n"
          #   cat response.md
          # } | gemini --yolo -m "gemini-3-flash-preview" > response_tmp.md
          # mv response_tmp.md response.md

          # 3回目: 最終調整 (テストのためコメントアウト)
          # echo "--- Phase 3: Final Refinement ---"
          # {
          #   cat .github/workflows/context/architecture-drafting.md
          #   echo -e "\n---\n# Current Context\n"
          #   cat current_issue.md
          #   echo -e "\n---\n# Previous Response\n"
          #   cat response.md
          # } | gemini --yolo -m "gemini-3-flash-preview" > response_tmp.md
          # mv response_tmp.md response.md

          # PR作成指示書とこれまでの履歴を渡して、GeminiにPR作成を任せる
          echo "--- Phase 4: PR Creation ---"
          {
            cat .github/workflows/context/pr-creation.md
            echo -e "\n---\n# Original Issue\n"
            cat current_issue.md
            echo -e "\n---\n# Final Implementation Result\n"
            cat response.md
          } | gemini --yolo -m "gemini-3-flash-preview"
